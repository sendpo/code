let art,currentPage=1,pageSize=30,totalPages=1,allEpisodes=[],movieData=null;document.addEventListener("DOMContentLoaded",()=>{movieData=localStorage.getItem("currentMovie");if(!movieData)return showError();movieData=JSON.parse(movieData);renderMovieDetail(movieData);bindCollapseEvents();bindRetryEvent()});function renderMovieDetail(e){const t=document.getElementById("moviePoster");e.pic?(t.src=e.pic,t.style.display="block"):t.style.display="none";const n=document.getElementById("movieTitle");e.name?(n.textContent=e.name,n.style.display="block",document.title=`${e.name} - 影视资源库`):(n.style.display="none",document.title="影视资源库");const o=document.getElementById("movieArea"),d=document.getElementById("areaContainer");e.area?(o.textContent=e.area,d.style.display="block"):d.style.display="none";const i=document.getElementById("movieLang"),l=document.getElementById("langContainer");e.lang?(i.textContent=e.lang,l.style.display="block"):l.style.display="none";const c=document.getElementById("movieYear"),y=document.getElementById("yearContainer");e.year?(c.textContent=e.year,y.style.display="block"):y.style.display="none";const a=document.getElementById("movieClass"),r=document.getElementById("classContainer");e.type_name?(a.textContent=e.type_name,r.style.display="block"):r.style.display="none";const s=document.getElementById("movieActor"),m=document.getElementById("actorContainer");e.actor?(s.textContent=e.actor,m.style.display="flex"):m.style.display="none";const p=document.getElementById("movieDirector"),u=document.getElementById("directorContainer");e.director?(p.textContent=e.director,u.style.display="flex"):u.style.display="none";const g=document.getElementById("movieScore"),h=document.getElementById("scoreContainer");e.score?(g.textContent=e.score,h.style.display="block"):h.style.display="none";const v=document.getElementById("movieRemarks"),E=document.getElementById("remarksContainer");e.update_info?(v.textContent=e.update_info,E.style.display="block"):E.style.display="none";const L=document.getElementById("movieContent"),b=document.getElementById("contentCard");e.content?(L.innerHTML=e.content,b.style.display="block"):b.style.display="none";const C=parsePlayUrls(e.play_url);renderEpisodeList(C);C.length>0&&initArtPlayer(C[0].url);document.getElementById("movieDetail").classList.remove("hidden");document.getElementById("loading").classList.add("hidden")}function parsePlayUrls(e){return!e||"0"===e?[]:e.split("#").map(e=>{const[t,n]=e.split("$");return{name:t||"未知",url:n}})}function calculateTotalPages(e){return Math.ceil(e.length/pageSize)}function renderPagination(){const e=document.getElementById("pagination");if(e.innerHTML="",!(totalPages<=1)){const t=Math.max(1,currentPage-2),n=Math.min(totalPages,currentPage+2),o=document.createElement("button");o.className=`px-2 py-1.5 rounded-lg border w-10 text-center text-xs leading-none ${1===currentPage?"opacity-50 cursor-not-allowed":"play-btn-hover border-gray-300 text-gray-700"}`,o.textContent="<",o.disabled=1===currentPage,o.onclick=()=>{currentPage>1&&(currentPage--,renderCurrentPageEpisodes())},e.appendChild(o);for(let o=t;o<=n;o++){const t=document.createElement("button");t.className=`px-2 py-1.5 rounded-lg border w-20 text-center text-xs leading-none ${o===currentPage?"episode-active":"play-btn-hover border-gray-300 text-gray-700"}`,t.textContent=`${(o-1)*pageSize+1}-${Math.min(o*pageSize,allEpisodes.length)}`,t.onclick=()=>{currentPage=o,renderCurrentPageEpisodes()},e.appendChild(t)}const d=document.createElement("button");d.className=`px-2 py-1.5 rounded-lg border w-10 text-center text-xs leading-none ${currentPage===totalPages?"opacity-50 cursor-not-allowed":"play-btn-hover border-gray-300 text-gray-700"}`,d.textContent=">",d.disabled=currentPage===totalPages,d.onclick=()=>{currentPage<totalPages&&(currentPage++,renderCurrentPageEpisodes())},e.appendChild(d)}}function renderCurrentPageEpisodes(){const e=document.getElementById("episodeList");e.innerHTML="";const t=(currentPage-1)*pageSize,n=Math.min(t+pageSize,allEpisodes.length),o=allEpisodes.slice(t,n);if(!o.length){e.innerHTML='<div class="col-span-full text-center text-gray-500 py-4 text-sm">暂无播放源</div>';return}o.forEach((o,d)=>{const i=document.createElement("button"),l=t+d;i.className=`play-btn-hover px-2 py-1.5 rounded-lg border text-sm ${0===l?"episode-active":"border-gray-300 text-gray-700"}`,i.textContent=o.name,i.onclick=()=>{document.querySelectorAll("#episodeList button").forEach(e=>e.classList.remove("episode-active")),i.classList.add("episode-active"),setVideo(o.url)},e.appendChild(i)}),renderPagination()}function renderEpisodeList(e){allEpisodes=e,totalPages=calculateTotalPages(e),currentPage=1,renderCurrentPageEpisodes()}function initArtPlayer(e){const t=document.getElementById("videoLoading");t.classList.remove("hidden"),art=new Artplayer({container:"#playerContainer",url:e,autoplay:!1,theme:"#165DFF",pip:!0,fullscreen:!0,autoSize:!1,playbackRate:!0,setting:!0,mutex:!0,fullscreenWeb:!0,customType:{m3u8:(e,t)=>{if(Hls.isSupported()){const n=new Hls;n.loadSource(t),n.attachMedia(e)}else e.src=t}}}),art.on("ready",()=>t.classList.add("hidden")),art.on("error",()=>{t.classList.add("hidden"),alert("视频加载失败，请尝试其他集数")})}function setVideo(e){art?(art.switchUrl(e),document.getElementById("videoLoading").classList.remove("hidden")):initArtPlayer(e)}function bindCollapseEvents(){document.querySelectorAll(".toggle-collapse").forEach(e=>{e.addEventListener("click",function(){const e=this.previousElementSibling;e.classList.toggle("expanded"),this.innerHTML=e.classList.contains("expanded")?'<i class="fa fa-angle-up"></i>':'<i class="fa fa-angle-down"></i>'})})}function bindRetryEvent(){document.getElementById("retryBtn").addEventListener("click",()=>{document.getElementById("error").classList.add("hidden"),document.getElementById("loading").classList.remove("hidden"),setTimeout(()=>{movieData?renderMovieDetail(movieData):showError()},500)})}function showError(){document.getElementById("loading").classList.add("hidden"),document.getElementById("error").classList.remove("hidden"),document.getElementById("movieDetail").classList.add("hidden")}
