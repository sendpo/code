let currentPage=1,totalPages=1,currentSource=localStorage.getItem("source")||"",isSearching=!1,searchKeyword="";document.addEventListener("DOMContentLoaded",async()=>{await loadSources();const e=document.getElementById("sourceSelect");currentSource||(currentSource=e.options[0]?.value||"",localStorage.setItem("source",currentSource)),e.value=currentSource,fetchMovies(currentPage),e.addEventListener("change",e=>{currentSource=e.target.value,localStorage.setItem("source",currentSource),currentPage=1,isSearching=!1,searchKeyword="",document.getElementById("searchInput").value="",document.getElementById("clearSearch").classList.add("hidden"),fetchMovies(currentPage,!0)}),document.getElementById("refreshBtn").addEventListener("click",()=>{isSearching=!1,searchKeyword="",document.getElementById("searchInput").value="",document.getElementById("clearSearch").classList.add("hidden"),fetchMovies(currentPage,!0)}),document.getElementById("prevPage").addEventListener("click",()=>{currentPage>1&&!isSearching&&(currentPage--,fetchMovies(currentPage),window.scrollTo({top:0,behavior:"smooth"}))}),document.getElementById("nextPage").addEventListener("click",()=>{currentPage<totalPages&&!isSearching&&(currentPage++,fetchMovies(currentPage),window.scrollTo({top:0,behavior:"smooth"}))}),document.getElementById("searchBtn").addEventListener("click",handleSearch),document.getElementById("searchInput").addEventListener("keydown",e=>{"Enter"===e.key&&handleSearch()}),document.getElementById("clearSearch").addEventListener("click",()=>{document.getElementById("searchInput").value="",document.getElementById("clearSearch").classList.add("hidden"),isSearching=!1,searchKeyword="",currentPage=1,fetchMovies(currentPage)}),document.getElementById("searchInput").addEventListener("input",e=>{document.getElementById("clearSearch").classList.toggle("hidden",!e.target.value)}),document.getElementById("retryBtn").addEventListener("click",()=>{fetchMovies(currentPage,!0)})});async function loadSources(){try{const e=new Date().toISOString().slice(0,10).replace(/-/g,""),t=`https://cdn.jsdelivr.net/gh/sendpo/code@refs/heads/main/json/fuli.json?v=${e}`;console.log("加载源 URL:",t);const n=await fetch(t,{cache:"no-store"}),a=await n.json(),o=document.getElementById("sourceSelect");o.innerHTML="",a.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name,o.appendChild(t)})}catch(e){alert("加载源配置失败: "+e.message)}}async function fetchMovies(e,t=!1){showLoading();try{const n=`http://movieapi.sendpo.cn/fuli/${currentSource}.php?ac=detail&pg=${e}`;console.log("请求URL:",n);const a=await fetch(n,{cache:t?"no-store":"default"}),o=await a.json();1===o.code&&Array.isArray(o.list)?(totalPages=o.pagecount||1,currentPage=o.page||1,renderMovieList(o.list),updatePagination(),document.getElementById("movieList").classList.remove("hidden"),document.getElementById("pagination").classList.remove("hidden"),document.getElementById("loading").classList.add("hidden")):showEmpty()}catch(e){console.error("获取数据失败:",e),showError()}}async function handleSearch(){if(searchKeyword=document.getElementById("searchInput").value.trim(),!searchKeyword)return;isSearching=!0,showLoading();try{const e=`http://movieapi.sendpo.cn/fuli/fuli_search.php?keyword=${encodeURIComponent(searchKeyword)}`;console.log("搜索请求URL:",e);const t=await fetch(e),n=await t.json();1===n.code&&Array.isArray(n.list)?(document.getElementById("pagination").classList.add("hidden"),document.getElementById("movieList").classList.remove("hidden"),document.getElementById("loading").classList.add("hidden"),0===n.list.length?showEmpty("暂无搜索结果"):renderMovieList(n.list,!0)):showEmpty("暂无搜索结果")}catch(e){console.error("搜索失败:",e),showError()}}function renderMovieList(e,t=!1){const n=document.getElementById("movieList");if(n.innerHTML="",!e.length)return void showEmpty(t?"暂无搜索结果":"暂无数据");e.forEach((e,a)=>{const o=document.createElement("div");o.className="bg-white rounded-xl overflow-hidden card-shadow card-hover cursor-pointer fade-in",o.style.animationDelay=`${.05*a}s`,o.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),localStorage.setItem("currentMovie",JSON.stringify(e)),window.open("fuli-detail.html","_blank")}),o.innerHTML=`<div class="relative overflow-hidden aspect-[2/3] bg-gradient-to-br from-gray-100 to-gray-200"><img src="${e.pic||"https://picsum.photos/400/600?grayscale&blur=2"}" alt="${e.name}" class="w-full h-full object-cover image-zoom" onerror="this.src='https://picsum.photos/400/600?grayscale&blur=2'"><div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 transition-opacity duration-300 card-hover:opacity-100"></div><div class="absolute top-2 left-2 bg-gray-800/80 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-full font-medium">${e.type_name||"未知类型"}</div>${t&&e.source?`<div class="absolute top-2 right-2 bg-primary text-white text-xs px-2 py-1 rounded-full font-medium">${e.source}</div>`:""}<div class="absolute bottom-2 right-2 bg-accent text-white text-xs px-2 py-1 rounded-full font-medium">${e.update_info||"未知"}</div><div class="absolute bottom-3 left-3 right-3 text-white opacity-0 transition-opacity duration-300 card-hover:opacity-100"><button class="w-full bg-primary hover:bg-primary/90 text-white text-sm py-2 rounded-lg transition-colors flex items-center justify-center"><i class="fa fa-play mr-1"></i> 查看详情</button></div></div><div class="p-4"><h3 class="font-bold text-lg mb-2 line-clamp-2 h-14" title="${e.name||"未知名称"}">${e.name||"未知名称"}</h3>${e.note?`<p class="text-xs text-accent mt-1">${e.note}</p>`:""}</div>`,n.appendChild(o)})}function updatePagination(){document.getElementById("pageInfo").textContent=`第 ${currentPage} 页 / 共 ${totalPages} 页`,document.getElementById("prevPage").disabled=currentPage<=1,document.getElementById("nextPage").disabled=currentPage>=totalPages}function showLoading(){document.getElementById("loading").classList.remove("hidden"),document.getElementById("error").classList.add("hidden"),document.getElementById("empty").classList.add("hidden"),document.getElementById("movieList").classList.add("hidden"),document.getElementById("pagination").classList.add("hidden")}function showError(){document.getElementById("loading").classList.add("hidden"),document.getElementById("error").classList.remove("hidden"),document.getElementById("empty").classList.add("hidden"),document.getElementById("movieList").classList.add("hidden"),document.getElementById("pagination").classList.add("hidden")}function showEmpty(e="暂无数据"){document.getElementById("loading").classList.add("hidden"),document.getElementById("error").classList.add("hidden"),document.getElementById("empty").classList.remove("hidden"),document.getElementById("movieList").classList.add("hidden"),document.getElementById("pagination").classList.add("hidden"),document.querySelector("#empty p").textContent=e}
