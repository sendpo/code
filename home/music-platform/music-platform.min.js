const API_KEY="DragonB5F24B43758599D5EA11384E7AECEEF7",API_BASE_URLS={wyy:"https://sdkapi.hhlqilongzhu.cn/api/dgMusic_wyy/",qq:"https://sdkapi.hhlqilongzhu.cn/api/QQmusic/",kugou:"https://sdkapi.hhlqilongzhu.cn/api/dgMusic_kugou/",kuwo:"https://sdkapi.hhlqilongzhu.cn/api/dgMusic_kuwo/",migu:"https://sdkapi.hhlqilongzhu.cn/api/dgMusic_migu/"};let currentSource="wyy",currentSong=null,searchResults=[],currentResultIndex=-1,searchQuery="",searchInput,searchBtn,sourceBtns,resultsSection,resultsList,resultsCount,noResults,loading,audioPlayer,playBtn,prevBtn,nextBtn,progressBar,progressSlider,currentTimeDisplay,totalTimeDisplay,volumeBtn,volumeBar,volumeSlider,songTitle,songArtist,albumCover,playerSection;function initEventListeners(){searchBtn.addEventListener("click",performSearch),searchInput.addEventListener("keypress",e=>{"Enter"===e.key&&performSearch()}),sourceBtns.forEach(t=>{t.addEventListener("click",()=>{sourceBtns.forEach(e=>{e.classList.remove("bg-primary","text-white","border-primary"),e.classList.add("bg-white","text-gray-700","border-gray-200")}),t.classList.remove("bg-white","text-gray-700","border-gray-200"),t.classList.add("bg-primary","text-white","border-primary"),currentSource=t.dataset.source;const e=searchInput.value.trim();e&&performSearch()})}),playBtn.addEventListener("click",togglePlay),prevBtn.addEventListener("click",playPrevious),nextBtn.addEventListener("click",playNext),audioPlayer.addEventListener("timeupdate",updateProgress),audioPlayer.addEventListener("ended",playNext),progressSlider.addEventListener("input",()=>{const e=parseInt(progressSlider.value),t=e/100*audioPlayer.duration;audioPlayer.currentTime=t}),volumeSlider.addEventListener("input",()=>{const e=parseInt(volumeSlider.value)/100;audioPlayer.volume=e,volumeBar.style.width=`${100*e}%`,0===e?volumeBtn.innerHTML='<i class="fa fa-volume-off"></i>':volumeBtn.innerHTML='<i class="fa fa-volume-up"></i>'}),volumeBtn.addEventListener("click",toggleMute)}async function performSearch(){const e=searchInput.value.trim();if(!e)return;searchInput.focus(),searchQuery=e,loading.classList.remove("hidden"),resultsSection.classList.add("hidden"),noResults.classList.add("hidden"),searchBtn.classList.add("pulse"),setTimeout(()=>{searchBtn.classList.remove("pulse")},2e3);try{const t=API_BASE_URLS[currentSource],a=new URLSearchParams({key:API_KEY,type:"json"});"wyy"===currentSource?a.append("gm",e):a.append("msg",e);const r=`${t}?${a.toString()}`,n=await fetch(r),s=await n.json();processSearchResults(s.data||[])}catch(e){console.error("搜索出错:",e),loading.classList.add("hidden"),noResults.classList.remove("hidden")}}function processSearchResults(e){if(loading.classList.add("hidden"),0===e.length)return void noResults.classList.remove("hidden");searchResults=e,resultsSection.classList.remove("hidden"),resultsCount.textContent=`${e.length}首`,resultsList.innerHTML="",e.forEach((e,t)=>{let a,r,n;switch(currentSource){case"wyy":case"kugou":case"migu":a=e.title,r=e.singer,n=e.cover||"https://p.sda1.dev/28/c198cf6d1b1a8ba794af07cdaf330d18/music.jpg";break;case"kuwo":a=e.songname,r=e.singer,n=e.pic||"https://p.sda1.dev/28/c198cf6d1b1a8ba794af07cdaf330d18/music.jpg",n&&!n.startsWith("http")&&(n=`https://${n}`);break;case"qq":a=e.song_title,r=e.song_singer,n=e.song_pic||"https://p.sda1.dev/28/c198cf6d1b1a8ba794af07cdaf330d18/music.jpg",n&&!n.startsWith("http")&&(n=`https://${n}`)}const s=document.createElement("div");s.className="music-card rounded-xl p-4",s.innerHTML=`<div class="flex items-center"><div class="w-14 h-14 rounded-lg overflow-hidden mr-4 flex-shrink-0"><img src="${n}" alt="${a}" class="w-full h-full object-cover"></div><div class="flex-1 min-w-0"><h3 class="font-semibold text-gray-800 mb-1 line-clamp-1">${a}</h3><p class="text-gray-600 text-sm line-clamp-1">${r}</p></div><button class="play-song-btn p-3 rounded-full bg-primary/10 text-primary hover:bg-primary/20 transition-colors mr-2" data-index="${t}"><i class="fa fa-play play-icon"></i></button><button class="download-song-btn p-3 rounded-full bg-secondary/10 text-secondary hover:bg-secondary/20 transition-colors" data-index="${t}"><i class="fa fa-download"></i></button></div>`,resultsList.appendChild(s),s.querySelector(".play-song-btn").addEventListener("click",e=>{const a=parseInt(e.currentTarget.dataset.index);playSong(a)}),s.querySelector(".download-song-btn").addEventListener("click",e=>{const a=parseInt(e.currentTarget.dataset.index);downloadSong(a)})})}async function playSong(e){currentResultIndex=e;const t=searchResults[e];if(!t)return void alert("未找到歌曲信息");try{const e=API_BASE_URLS[currentSource],a=new URLSearchParams({key:API_KEY,type:"json",n:t.n||t.song_mid||t.id||""});"wyy"===currentSource?a.append("gm",searchQuery):a.append("msg",searchQuery);const r=`${e}?${a.toString()}`,n=await fetch(r),s=await n.json();let o,i,l;switch(currentSource){case"wyy":case"kugou":case"migu":o=s,i=o.music_url,l=o.cover||"https://p.sda1.dev/28/c198cf6d1b1a8ba794af07cdaf330d18/music.jpg";break;case"kuwo":o=s,i=o.flac_url||o.mp3_url,l=o.cover||"https://p.sda1.dev/28/c198cf6d1b1a8ba794af07cdaf330d18/music.jpg";break;case"qq":o=s.data,i=o.music_url,l=o.cover||"https://p.sda1.dev/28/c198cf6d1b1a8ba794af07cdaf330d18/music.jpg"}if(!i)return void alert("无法获取播放链接");currentSong={title:getSongTitle(o),artist:getSongArtist(o),cover:l,url:i},updatePlayerUI(),audioPlayer.src=currentSong.url,audioPlayer.play(),playBtn.innerHTML='<i class="fa fa-pause"></i>',document.getElementById("album-cover").classList.add("playing")}catch(e){console.error("播放出错:",e),alert("播放失败，请尝试其他歌曲")}}async function downloadSong(e){const t=searchResults[e];if(!t)return void alert("未找到歌曲信息，无法下载");const a=document.querySelector(`.download-song-btn[data-index="${e}"]`),r=a.innerHTML;a.innerHTML='<i class="fa fa-spinner fa-spin"></i>',a.disabled=!0;try{const e=API_BASE_URLS[currentSource],r=new URLSearchParams({key:API_KEY,type:"json",n:t.n||t.song_mid||t.id||""});"wyy"===currentSource?r.append("gm",searchQuery):r.append("msg",searchQuery);const n=`${e}?${r.toString()}`,s=await fetch(n),o=await s.json();let i,l,c;switch(currentSource){case"wyy":case"kugou":case"migu":i=o.music_url,l=o.title,c=o.singer;break;case"kuwo":i=o.flac_url||o.mp3_url,l=o.song_name,c=o.song_singer;break;case"qq":i=o.data?.music_url,l=o.data?.song_name,c=o.data?.song_singer}if(!i||i.includes("null")||!i.startsWith("http"))throw new Error("无法获取有效下载链接，该歌曲可能受版权保护");const d=document.createElement("a");d.href=i,d.download=`${l||"未知歌曲"} - ${c||"未知歌手"}.mp3`,d.style.display="none",document.body.appendChild(d),d.click(),document.body.removeChild(d),alert(`下载已触发：${l||"未知歌曲"}`)}catch(e){console.error("下载失败:",e),alert(`下载失败：${e.message}`)}finally{a.innerHTML=r,a.disabled=!1}}function getSongTitle(e){switch(currentSource){case"wyy":case"kugou":case"migu":return e.title;case"kuwo":return e.song_name;case"qq":return e.song_name;default:return"未知歌曲"}}function getSongArtist(e){switch(currentSource){case"wyy":case"kugou":case"migu":return e.singer;case"kuwo":case"qq":return e.song_singer;default:return"未知艺术家"}}function updatePlayerUI(){currentSong&&(songTitle.textContent=currentSong.title,songArtist.textContent=currentSong.artist,albumCover.src=currentSong.cover,albumCover.alt=currentSong.title,albumCover.onerror=function(){this.src="https://p.sda1.dev/28/c198cf6d1b1a8ba794af07cdaf330d18/music.jpg"},playerSection.classList.remove("translate-y-full"))}function togglePlay(){audioPlayer.src&&(audioPlayer.paused?(audioPlayer.play(),playBtn.innerHTML='<i class="fa fa-pause"></i>',document.getElementById("album-cover").classList.add("playing")):(audioPlayer.pause(),playBtn.innerHTML='<i class="fa fa-play"></i>',document.getElementById("album-cover").classList.remove("playing")))}function playPrevious(){if(0!==searchResults.length){let e=currentResultIndex-1;e<0&&(e=searchResults.length-1),playSong(e)}}function playNext(){if(0!==searchResults.length){let e=currentResultIndex+1;e>=searchResults.length&&(e=0),playSong(e)}}function updateProgress(){const{currentTime:e,duration:t}=audioPlayer;if(!isNaN(t)){const a=e/t*100;progressBar.style.width=`${a}%`,progressSlider.value=a,currentTimeDisplay.textContent=formatTime(e),totalTimeDisplay.textContent=formatTime(t)}}function formatTime(e){const t=Math.floor(e/60),a=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`}function toggleMute(){audioPlayer.muted=!audioPlayer.muted,audioPlayer.muted?(volumeBtn.innerHTML='<i class="fa fa-volume-off"></i>',volumeBar.style.width="0%",volumeSlider.value=0):(volumeBtn.innerHTML='<i class="fa fa-volume-up"></i>',volumeBar.style.width=`${100*audioPlayer.volume}%`,volumeSlider.value=100*audioPlayer.volume)}function init(){searchInput=document.getElementById("search-input"),searchBtn=document.getElementById("search-btn"),sourceBtns=document.querySelectorAll(".source-btn"),resultsSection=document.getElementById("results-section"),resultsList=document.getElementById("results-list"),resultsCount=document.getElementById("results-count"),noResults=document.getElementById("no-results"),loading=document.getElementById("loading"),audioPlayer=document.getElementById("audio-player"),playBtn=document.getElementById("play-btn"),prevBtn=document.getElementById("prev-btn"),nextBtn=document.getElementById("next-btn"),progressBar=document.getElementById("progress-bar"),progressSlider=document.getElementById("progress-slider"),currentTimeDisplay=document.getElementById("current-time"),totalTimeDisplay=document.getElementById("total-time"),volumeBtn=document.getElementById("volume-btn"),volumeBar=document.getElementById("volume-bar"),volumeSlider=document.getElementById("volume-slider"),songTitle=document.getElementById("song-title"),songArtist=document.getElementById("song-artist"),albumCover=document.querySelector("#album-cover img"),playerSection=document.getElementById("player-section"),initEventListeners(),audioPlayer.volume=.75,volumeBar.style.width="75%",sourceBtns[0].classList.add("bg-primary","text-white","border-primary"),sourceBtns[0].classList.remove("bg-white","text-gray-700","border-gray-200")}document.addEventListener("DOMContentLoaded",init);
