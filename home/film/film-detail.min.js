let art,currentPage=1,pageSize=30,totalPages=1,allEpisodes=[],movieData=null;document.addEventListener("DOMContentLoaded",()=>{if(movieData=localStorage.getItem("currentMovie"),!movieData)return showError();movieData=JSON.parse(movieData),renderMovieDetail(movieData),bindCollapseEvents(),bindRetryEvent()});function renderMovieDetail(e){document.getElementById("moviePoster").src=e.pic||"https://picsum.photos/400/600?grayscale&blur=2",document.getElementById("movieTitle").textContent=e.name||"未知影片",document.title=`${e.name||'未知影片'} - 影视资源库`,document.getElementById("movieArea").textContent=e.area||"未知",document.getElementById("movieLang").textContent=e.lang||"未知",document.getElementById("movieYear").textContent=e.year||"未知",document.getElementById("movieClass").textContent=e.type_name||"未知",document.getElementById("movieActor").textContent=e.actor||"未知",document.getElementById("movieDirector").textContent=e.director||"未知",document.getElementById("movieScore").textContent=e.score||"暂无",document.getElementById("movieRemarks").textContent=e.update_info||"未知",document.getElementById("movieContent").innerHTML=e.content||"暂无简介";const t=parsePlayUrls(e.play_url);renderEpisodeList(t),t.length>0&&initArtPlayer(t[0].url),document.getElementById("movieDetail").classList.remove("hidden"),document.getElementById("loading").classList.add("hidden")}function parsePlayUrls(e){return!e||"0"===e?[]:e.split("#").map(e=>{const[t,o]=e.split("$");return{name:t||"未知",url:o}})}function calculateTotalPages(e){return Math.ceil(e.length/pageSize)}function renderPagination(){const e=document.getElementById("pagination");if(e.innerHTML="",!(totalPages<=1)){const t=Math.max(1,currentPage-2),o=Math.min(totalPages,currentPage+2),n=document.createElement("button");n.className=`px-2 py-1.5 rounded-lg border w-10 text-center text-xs leading-none ${1===currentPage?"opacity-50 cursor-not-allowed":"play-btn-hover border-gray-300 text-gray-700"}`,n.textContent="<",n.disabled=1===currentPage,n.onclick=()=>{currentPage>1&&(currentPage--,renderCurrentPageEpisodes())},e.appendChild(n);for(let n=t;n<=o;n++){const t=document.createElement("button");t.className=`px-2 py-1.5 rounded-lg border w-20 text-center text-xs leading-none ${n===currentPage?"episode-active":"play-btn-hover border-gray-300 text-gray-700"}`,t.textContent=`${(n-1)*pageSize+1}-${Math.min(n*pageSize,allEpisodes.length)}`,t.onclick=()=>{currentPage=n,renderCurrentPageEpisodes()},e.appendChild(t)}const a=document.createElement("button");a.className=`px-2 py-1.5 rounded-lg border w-10 text-center text-xs leading-none ${currentPage===totalPages?"opacity-50 cursor-not-allowed":"play-btn-hover border-gray-300 text-gray-700"}`,a.textContent=">",a.disabled=currentPage===totalPages,a.onclick=()=>{currentPage<totalPages&&(currentPage++,renderCurrentPageEpisodes())},e.appendChild(a)}}function renderCurrentPageEpisodes(){const e=document.getElementById("episodeList");e.innerHTML="";const t=(currentPage-1)*pageSize,o=Math.min(t+pageSize,allEpisodes.length),n=allEpisodes.slice(t,o);if(!n.length)return void(e.innerHTML='<div class="col-span-full text-center text-gray-500 py-4 text-sm">暂无播放源</div>');n.forEach((o,n)=>{const a=document.createElement("button"),r=t+n;a.className=`play-btn-hover px-2 py-1.5 rounded-lg border text-sm ${0===r?"episode-active":"border-gray-300 text-gray-700"}`,a.textContent=o.name,a.onclick=()=>{document.querySelectorAll("#episodeList button").forEach(e=>e.classList.remove("episode-active")),a.classList.add("episode-active"),setVideo(o.url)},e.appendChild(a)}),renderPagination()}function renderEpisodeList(e){allEpisodes=e,totalPages=calculateTotalPages(e),currentPage=1,renderCurrentPageEpisodes()}function initArtPlayer(e){const t=document.getElementById("videoLoading");t.classList.remove("hidden"),art=new Artplayer({container:"#playerContainer",url:e,autoplay:!1,theme:"#165DFF",pip:!0,fullscreen:!0,autoSize:!1,playbackRate:!0,setting:!0,mutex:!0,fullscreenWeb:!0,customType:{m3u8:(e,t)=>{if(Hls.isSupported()){const o=new Hls;o.loadSource(t),o.attachMedia(e)}else e.src=t}}}),art.on("ready",()=>t.classList.add("hidden")),art.on("error",()=>{t.classList.add("hidden"),alert("视频加载失败，请尝试其他集数")})}function setVideo(e){art?(art.switchUrl(e),document.getElementById("videoLoading").classList.remove("hidden")):initArtPlayer(e)}function bindCollapseEvents(){document.querySelectorAll(".toggle-collapse").forEach(e=>{e.addEventListener("click",function(){const t=this.previousElementSibling;t.classList.toggle("expanded"),this.innerHTML=t.classList.contains("expanded")?'<i class="fa fa-angle-up"></i>':'<i class="fa fa-angle-down"></i>'})})}function bindRetryEvent(){document.getElementById("retryBtn").addEventListener("click",()=>{document.getElementById("error").classList.add("hidden"),document.getElementById("loading").classList.remove("hidden"),setTimeout(()=>{movieData?renderMovieDetail(movieData):showError()},500)})}function showError(){document.getElementById("loading").classList.add("hidden"),document.getElementById("error").classList.remove("hidden"),document.getElementById("movieDetail").classList.add("hidden")}